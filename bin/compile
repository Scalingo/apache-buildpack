#!/bin/bash

basedir="$( cd -P "$( dirname "$0" )" && pwd )"

# Set errors
set -e

# Configure directories
BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3

export APACHE_DIR="${APACHE_DIR:-$BUILD_DIR/vendor/apache2}"
export APACHE_LOG_DIR="${APACHE_LOG_DIR:-$APACHE_DIR/logs}"

echo "apache2" >> $BUILD_DIR/Aptfile

if [ -f "${BUILD_DIR}/.apache-mods" ] ; then
  for apache_mod in $(cat "${BUILD_DIR}/.apache-mods") ; do
    echo "libapache2-mod-${apache_mod}" >> $BUILD_DIR/Aptfile
  done
fi

apt_deps_buildpack_dir=$(mktemp apt_buildpack_XXXX)

# only the name is interesting, deleting the temp empty file
rm "$apt_deps_buildpack_dir"

APT_BUILDPACK_URL="${APT_BUILDPACK_URL:-https://github.com/Scalingo/apt-buildpack}"
git clone --depth=1 "$APT_BUILDPACK_URL" "$apt_deps_buildpack_dir"

"${apt_deps_buildpack_dir}/bin/compile" "$BUILD_DIR" "$CACHE_DIR" "$ENV_DIR"

rm -r "$apt_deps_buildpack_dir"

mkdir -p "${APACHE_DIR}/logs"
mkdir -p "${APACHE_DIR}/conf"

cp "${basedir}/../conf/httpd.conf.erb" "${APACHE_DIR}/conf/httpd.conf.erb"

mkdir -p "${BUILD_DIR}/bin"
cp "${basedir}/startup.sh" "${BUILD_DIR}/bin/startup.sh"

if grep -q "auth-mellon" "${BUILD_DIR}/.apache-mods" ; then
  
  export MELLON_DIR="${MELLON_DIR:-$APACHE_DIR/mellon}"
  mkdir -p "${MELLON_DIR}"

  if [[ ( ! -f "${ENV_DIR}/MELLON_SP_METADATA" ) ]]; then
    echo "WARNING: MELLON_SP_METADATA is not set. Mellon may not work!"
  else
    echo "Exporting xml matadata file..."
    cat "${ENV_DIR}/MELLON_SP_METADATA" | base64 --decode >> "${MELLON_DIR}/mellon.xml"
    chmod 644 ${MELLON_DIR}/mellon.xml
  fi

  if [[ ( ! -f "${ENV_DIR}/MELLON_SP_CERT" ) ]]; then
    echo "WARNING: MELLON_SP_CERT is not set. Mellon may not work!"
  else
    echo "Exporting certificate file..."
    cat "${ENV_DIR}/MELLON_SP_CERT" | base64 --decode >> "${MELLON_DIR}/mellon.cert"
    chmod 644 ${MELLON_DIR}/mellon.cert
  fi

  if [[ ( ! -f "${ENV_DIR}/MELLON_SP_KEY" ) ]]; then
    echo "WARNING: MELLON_SP_KEY is not set. Mellon may not work!"
  else
    echo "Exporting key file..."
    cat "${ENV_DIR}/MELLON_SP_KEY" | base64 --decode >> "${MELLON_DIR}/mellon.key"
    chmod 600 ${MELLON_DIR}/mellon.key
  fi

  if [[ ( ! -f "${ENV_DIR}/MELLON_IDP_METADATA" ) ]]; then
    echo "WARNING: MELLON_IDP_METADATA is not set. Mellon may not work!"
  else
    echo "Exporting IdP xml metadata file..."
    cat "${ENV_DIR}/MELLON_IDP_METADATA" | base64 --decode >> "${MELLON_DIR}/mellon_idp_metadata.xml"
    chmod 644 ${MELLON_DIR}/mellon_idp_metadata.xml
  fi
fi
