#!/bin/bash

basedir="$( cd -P "$( dirname "$0" )" && pwd )"

# Set errors
set -e

# Configure directories
BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3

export APACHE_DIR="${APACHE_DIR:-/app/vendor/apache2}"
export APACHE_LOG_DIR="${APACHE_LOG_DIR:-/app/vendor/apache2/logs}"

if [ ! [ -f $BUILD_DIR/httpd.conf ] || [ -f $BUILD_DIR/httpd.conf.erb ]] ; then
  echo "No httpd.conf file found in BUILD dir! Exiting..."
  exit 1
fi

echo "apache2" >> $BUILD_DIR/Aptfile

if [ "$APACHE_MODE" = "openidc" ] ; then
  echo "Installing Apache and mod_openidc using apt-buildpack..."

  echo "libcjose0" >> $BUILD_DIR/Aptfile
  echo "libhiredis0.14" >> $BUILD_DIR/Aptfile
  echo "libapache2-mod-auth-openidc" >> $BUILD_DIR/Aptfile
fi

if [ "$APACHE_MODE" = "mellon" ] ; then
  echo "libapache2-mod-auth-mellon" >> $BUILD_DIR/Aptfile
fi

apt_deps_buildpack_dir=$(mktemp apt_buildpack_XXXX)

# only the name is interesting, deleting the temp empty file
rm "$apt_deps_buildpack_dir"

APT_BUILDPACK_URL="${APT_BUILDPACK_URL:-https://github.com/Scalingo/apt-buildpack}"
git clone --depth=1 "$APT_BUILDPACK_URL" "$apt_deps_buildpack_dir"

"${apt_deps_buildpack_dir}/bin/compile" "$BUILD_DIR" "$CACHE_DIR" "$ENV_DIR"

rm -r "$apt_deps_buildpack_dir"

mkdir -p "$APACHE_DIR/logs"
mkdir -p "$APACHE_DIR/conf"

# copying the conf to the apache2 folder

cp -R $BUILD_DIR/.apt/* $APACHE_DIR

cp $BUILD_DIR/httpd.conf $APACHE_DIR/conf/httpd.conf

#mkdir -p "/app/vendor/apache2/logs"

export

erb $BUILD_DIR/httpd.conf.erb > $APACHE_DIR/conf/httpd.conf