#!/bin/bash

basedir="$( cd -P "$( dirname "$0" )" && pwd )"

# Set errors
set -e

# set debug
set -x

# Configure directories
BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3

export APACHE_LOG_DIR="${APACHE_LOG_DIR:-/app/vendor/apache2/logs}"

echo "Install Apache and deps with apt-buildpack"

cat >> $BUILD_DIR/Aptfile <<EOF
apache2
libcjose0
libhiredis0.14
libapache2-mod-auth-openidc
EOF

apt_deps_buildpack_dir=$(mktemp apt_buildpack_XXXX)

# only the name is interesting, deleting the temp empty file
rm "$apt_deps_buildpack_dir"

APT_BUILDPACK_URL="${APT_BUILDPACK_URL:-https://github.com/Scalingo/apt-buildpack}"
git clone --depth=1 "$APT_BUILDPACK_URL" "$apt_deps_buildpack_dir"

"${apt_deps_buildpack_dir}/bin/compile" "$BUILD_DIR" "$CACHE_DIR" "$ENV_DIR"

rm -r "$apt_deps_buildpack_dir"

# copying the .apt content to the /app/vendor/apache2 tree
mkdir -p "/app/vendor/apache2"

#if [[ -f "/.apt" ]]; then
  echo "copying .apt dir"
  cp -RT "/.apt" "/app/vendor/apache2"
#fi


# copying the conf to the apache2 folder
mkdir -p "/app/vendor/apache2/conf"
mkdir -p "/app/vendor/apache2/logs"

cp -r "$basedir/conf/httpd.conf" "/app/vendor/apache2/conf/httpd.conf"

# starting apache
# /etc/init.d/apache2 -c "/app/vendor/apache2/conf/httpd.conf" start